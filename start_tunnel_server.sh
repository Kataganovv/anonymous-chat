#!/bin/bash

# ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ‡Ð°Ñ‚Ñƒ
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ðµ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð±ÐµÐ· Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° (Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´)..."
echo ""

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð² Ñ„Ð¾Ð½Ðµ
echo "ðŸŒ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8000..."
cd "$(dirname "$0")"
python3 -m http.server 8000 --bind 0.0.0.0 &
SERVER_PID=$!

# Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¿Ð¾ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ
sleep 2

echo "ðŸ”— Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ Ñ‡ÐµÑ€ÐµÐ· serveo.net..."
echo ""

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ Ñ‡ÐµÑ€ÐµÐ· SSH (serveo.net)
ssh -o StrictHostKeyChecking=no -R 80:localhost:8000 serveo.net > serveo.log 2>&1 &
SERVEO_PID=$!

# Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ
sleep 5

# Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ URL Ð¸Ð· Ð»Ð¾Ð³Ð°
PUBLIC_URL=$(grep -o "https://[^[:space:]]*\.serveo\.net" serveo.log | head -1)

if [[ -n "$PUBLIC_URL" ]]; then
    echo ""
    echo "ðŸŽ‰ Ð¡ÐµÑ€Ð²ÐµÑ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
    echo ""
    echo "ðŸ“± ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð°Ñ ÑÑÑ‹Ð»ÐºÐ° (Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð²ÑÐµÐ¼ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ðµ):"
    echo "   $PUBLIC_URL"
    echo ""
    echo "ðŸ’» Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ ÑÑÑ‹Ð»ÐºÐ°:"
    echo "   http://localhost:8000"
    echo ""
    echo "ðŸ”— QR-ÐºÐ¾Ð´ Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸:"
    echo "   $PUBLIC_URL/connect.html"
    echo ""
    echo "âš ï¸  Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: Ð¡ÑÑ‹Ð»ÐºÐ° Ð±ÑƒÐ´ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð° Ð¿Ð¾ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚"
    echo "ðŸ’¡ Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C"
    echo ""
    
    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ URL Ð´Ð»Ñ Ð²ÐµÐ±-ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
    echo "$PUBLIC_URL" > public_url.txt
    
    echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÐµÑÑŒ ÑÑÑ‹Ð»ÐºÐ¾Ð¹ Ñ Ð´Ñ€ÑƒÐ·ÑŒÑÐ¼Ð¸!"
    echo ""
    echo "ðŸ”„ Ð•ÑÐ»Ð¸ ÑÑÑ‹Ð»ÐºÐ° Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ start_public_server.sh"
    echo ""
    
    # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ
    wait $SERVEO_PID
else
    echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ Ñ‡ÐµÑ€ÐµÐ· serveo.net"
    echo ""
    echo "ðŸ”„ ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ localhost.run..."
    
    # ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ñ‡ÐµÑ€ÐµÐ· localhost.run
    ssh -o StrictHostKeyChecking=no -R 80:localhost:8000 ssh.localhost.run > localhost_run.log 2>&1 &
    LR_PID=$!
    
    sleep 5
    
    PUBLIC_URL=$(grep -o "https://[^[:space:]]*\.lhr\.life" localhost_run.log | head -1)
    
    if [[ -n "$PUBLIC_URL" ]]; then
        echo ""
        echo "ðŸŽ‰ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· localhost.run!"
        echo ""
        echo "ðŸ“± ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð°Ñ ÑÑÑ‹Ð»ÐºÐ°:"
        echo "   $PUBLIC_URL"
        echo ""
        echo "$PUBLIC_URL" > public_url.txt
        
        wait $LR_PID
    else
        echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿"
        echo ""
        echo "ðŸ’¡ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:"
        echo "   1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ngrok: brew install ngrok"
        echo "   2. Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ ÑÐµÑ‚ÑŒ: ./start_server.sh"
    fi
fi

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸
trap 'kill $SERVER_PID $SERVEO_PID $LR_PID 2>/dev/null; rm -f serveo.log localhost_run.log public_url.txt' EXIT