#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É —á–µ—Ä–µ–∑ SSH —Ç—É–Ω–Ω–µ–ª—å

PORT=8000
TUNNEL_SERVICE="serveo.net"

echo "üåê –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ —á–∞—Ç–∞..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
if ! curl -s http://localhost:$PORT > /dev/null 2>&1; then
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
    python3 -m http.server $PORT --bind 0.0.0.0 &
    SERVER_PID=$!
    sleep 3
fi

echo "üîó –°–æ–∑–¥–∞—é –ø—É–±–ª–∏—á–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å —á–µ—Ä–µ–∑ $TUNNEL_SERVICE..."
echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É–Ω–Ω–µ–ª—è..."

# –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å —á–µ—Ä–µ–∑ serveo.net
ssh -o StrictHostKeyChecking=no -R 80:localhost:$PORT serveo.net &
TUNNEL_PID=$!

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª—è
sleep 5

echo ""
echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω!"
echo ""
echo "üì± –ü—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞:"
echo "   https://[generated-subdomain].serveo.net/"
echo ""
echo "üíª –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø:"
echo "   http://localhost:$PORT/"
echo ""
echo "üìã –ß—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å, –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
    if [ ! -z "$SERVER_PID" ]; then
        kill $SERVER_PID 2>/dev/null
    fi
    if [ ! -z "$TUNNEL_PID" ]; then
        kill $TUNNEL_PID 2>/dev/null
    fi
    exit 0
}

trap cleanup INT TERM

# –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
wait